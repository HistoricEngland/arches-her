<!--
ARCHES - a program developed to inventory and manage immovable cultural heritage.
Copyright (C) 2013 J. Paul Getty Trust and World Monuments Fund

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU Affero General Public License as
published by the Free Software Foundation, either version 3 of the
License, or (at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU Affero General Public License for more details.

You should have received a copy of the GNU Affero General Public License
along with this program. If not, see <http://www.gnu.org/licenses/>.
-->
{% load staticfiles %}
{% load i18n %}
{% load compress %}

<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9"> <![endif]-->
<!--[if !IE]><!--> <html lang="en"> <!--<![endif]-->

{% if use_livereload %}
    <script>document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':{{ livereload_port }}/livereload.js?snipver=1"></' + 'script>')</script>
{% endif %}

<head>
    <title>{% block title %}{{ app_settings.APP_NAME }} - {% endblock title %}</title>

    <!-- Meta -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <link rel="shortcut icon" href="{% static 'favicons/favicon.png' %}">
    <link href="{% static 'favicons/apple-touch-icon.png' %}" rel="apple-touch-icon" />
    <link href="{% static 'favicons/apple-touch-icon-76x76.png' %}" rel="apple-touch-icon" sizes="76x76" />
    <link href="{% static 'favicons/apple-touch-icon-120x120.png' %}" rel="apple-touch-icon" sizes="120x120" />
    <link href="{% static 'favicons/apple-touch-icon-152x152.png' %}" rel="apple-touch-icon" sizes="152x152" />
    <link href="{% static 'favicons/apple-touch-icon-180x180.png' %}" rel="apple-touch-icon" sizes="180x180" />
    <link href="{% static 'favicons/icon-hires.png' %}" rel="icon" sizes="192x192" />
    <link href="{% static 'favicons/icon-normal.png' %}" rel="icon" sizes="128x128" />

    {% block css %}
        {% compress css %}
        <link type="text/x-scss" href="{% static 'css/arches.scss' %}" rel="stylesheet" media="screen">
    	{% endcompress %}
        {% if app_settings.ACCESSIBILITY_MODE %}
        <link href="{% static 'css/accessibility.css' %}" rel="stylesheet">
        {% endif %}
        <link href="{% static 'css/package.css' %}" rel="stylesheet">
        <link href="{% static 'css/project.css' %}" rel="stylesheet">
    {% endblock css%}

    <script type="text/javascript">
        // ##### APPINSIGHTS MONITORING #####
        var aikey = '#{appinsights-key}#';
        if (/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/.test(aikey) == true) {
            console.log("aikey valid", aikey);
            var appInsights = window.appInsights || function (a) { function b(a) { c[a] = function () { var b = arguments; c.queue.push(function () { c[a].apply(c, b) }) } } var c = { config: a }, d = document, e = window; setTimeout(function () { var b = d.createElement("script"); b.src = a.url || "https://az416426.vo.msecnd.net/scripts/a/ai.0.js", d.getElementsByTagName("script")[0].parentNode.appendChild(b) }); try { c.cookie = d.cookie } catch (a) { } c.queue = []; for (var f = ["Event", "Exception", "Metric", "PageView", "Trace", "Dependency"]; f.length;)b("track" + f.pop()); if (b("setAuthenticatedUserContext"), b("clearAuthenticatedUserContext"), b("startTrackEvent"), b("stopTrackEvent"), b("startTrackPage"), b("stopTrackPage"), b("flush"), !a.disableExceptionTracking) { f = "onerror", b("_" + f); var g = e[f]; e[f] = function (a, b, d, e, h) { var i = g && g(a, b, d, e, h); return !0 !== i && c["_" + f](a, b, d, e, h), i } } return c }({ instrumentationKey: aikey }); window.appInsights = appInsights, appInsights.queue && 0 === appInsights.queue.length && appInsights.trackPageView();
        }
        else {
            console.log("aikey not valid - app insights not instantiated");
        }
            //####################################
    </script>
    <script src="https://cc.cdn.civiccomputing.com/9/cookieControl-9.5.min.js"></script>
    <script src="{{ STATIC_URL }}js/cookieControl.js"></script>

</head>

<body {% block body_attributes %}class="scroll-y-auto"{% endblock %}>
    {% block loading_mask %}

    <div class="loading-mask" data-bind="visible: typeof(loading()) === 'boolean' && loading()"></div>

    <div class="loading-mask" style="display: none;" data-bind="visible: typeof(loading()==='string') && loading().length > 0">
        <div class="loading-mask-string" data-bind="text: loading"></div>
    </div>


    {% endblock loading_mask %}
    {% block body %}

    {% endblock body %}
</body>

{% block javascript %}
    <script>
        //Check for escape key pressed, and if any modals/popups open, close them
        document.onkeydown = function(evt) {
            evt = evt || window.event;
            var isEscape = false;
            if ('key' in evt) {
                isEscape = (evt.key === 'Escape' || evt.key === 'Esc');
            } else {
                isEscape = (evt.keyCode === 27);
            }
            if (isEscape) {
                try {
                    //Main left nav
                    var leftnavcontainer = document.getElementsByClassName('mainnav-lg')[0];
                    if(leftnavcontainer) {
                        var el = document.getElementsByClassName('navbar-brand')[0];
                        el.click();
                    }
                    //Top message
                    var topdisplayed = document.getElementById('card-alert-panel');
                    if(topdisplayed) {
                        if(topdisplayed.style.display != 'none') {
                            topdisplayed.style.display = 'none';
                        }
                    }
                    //Sidebar panel
                    var sidebarpanel = document.getElementsByClassName('workbench-card-sidepanel')[0];
                    if(sidebarpanel) {
                        var el = document.getElementsByClassName('workbench-card-sidepanel-header')[0];
                        el.click();
                    }
                    //Notifications panel
                    var notifpanel = document.getElementById('ep-notifs-panel');
                    if(notifpanel) {
                        if(notifpanel.style.display != 'none') {
                            document.getElementsByClassName('ep-notifs-close')[0].click();
                        }
                    }
                    //Edits panel
                    var editspanel = document.getElementById('ep-edits-panel');
                    if(editspanel) {
                        if(editspanel.style.display != 'none') {
                            document.getElementsByClassName('ep-edits-close')[0].click();
                        }
                    }
                    //Help panel
                    var helppanel = document.getElementById('ep-help-panel');
                    if(helppanel) {
                        if(helppanel.style.display != 'none') {
                            document.getElementsByClassName('ep-help-close')[0].click();
                        }
                    }
                    //Manage menu panel
                    var managepanel = document.getElementById('menu-panel');
                    if(managepanel) {
                        if(managepanel.style.display != 'none') {
                            document.getElementById('menu-control').click();
                        }
                    }
                    //Profile popup form
                    var profilepanel = document.getElementsByClassName('change-password-form')[0];
                    if(profilepanel) {
                        if(profilepanel.style.display != 'none') {
                            document.getElementsByClassName('btn-profile-password')[0].click();
                        }
                    }
                    //Search top right panels
                    var toprightpanel = document.getElementsByClassName('active')[0];
                    if(toprightpanel) {
                        if(toprightpanel.style.display != 'none') {
                            document.querySelectorAll('.saved-search-container.search-type-btn-popup.active')[0].click();
                        }
                    }
                } catch (err) {
                    return;
                }
            }
        };
    </script>

    <script src="{{ STATIC_URL }}packages/requirejs/require.js"></script>

    {% block pre_require_js %}
    {% endblock pre_require_js %}

    {% include 'javascript.htm' %}

    <script>
        require(["nifty"{% if main_script %},"{{ main_script }}"{% endif %}]);
    </script>

    {% if analytics_cookies or accept_all_cookies and app_settings.GOOGLE_ANALYTICS_TRACKING_ID != None %}
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', '{{app_settings.GOOGLE_ANALYTICS_TRACKING_ID}}', 'auto');
        ga('send', 'pageview');
    </script>
    {% endif %}

    <script>
        // Detect clicks
        document.addEventListener('click', function (event) {
            
            // Left nav toggle
            if (event.target.matches('#menu-toggle, #menu-toggle>*')){
                event.preventDefault();
                if($('#container').hasClass('mainnav-sm')){
                    $('#mainnav-container').removeClass('menu-expanded');
                } else{
                    $('#mainnav-container').addClass('menu-expanded');
                }
            
            // Return if no matches
            } else {
                return;
            }
        }, false);
    </script>

{% endblock javascript %}

</html>
